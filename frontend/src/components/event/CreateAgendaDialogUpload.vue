<script setup>
import { ref } from "vue";
import { useQuasar } from "quasar";
import { api } from "boot/axios";

const $q = useQuasar();
const imageObj = ref(null);

const previewImageUrl = ref("");

function counterLabelFn({ totalSize }) {
	return `${totalSize}`;
}

function imageUploadChange(image) {
	console.log(image);
	if (image) {
		previewImageUrl.value = URL.createObjectURL(imageObj.value);
	}
}

function submitImagePlan() {
	if (!imageObj.value) {
		$q.notify({ message: "Please select a valid file to upload", color: "negative" });
	}
	const form = new FormData();
	form.append("image", imageObj.value);
	// TODO: set this fields by user's current calendar week page
	form.append("year", 2023);
	form.append("calendar_week", 31);

	api
		.post("/ki/upload/", form)
		.then((response) => {
			console.log(response);
		})
		.catch((err) => {
			console.error("Fehler: ", err);
		});
}

function clearImageUploadInput() {
	previewImageUrl.value = "";
	imageObj.value = null;
}
</script>

<template>
	<div class="flex column fa-align-center full-width">
		<p>Select a file to import all events at once</p>
		<q-form>
			<q-file
				v-model="imageObj"
				:counter-label="counterLabelFn"
				clearable
				counter
				filled
				hint="Allowed types are: jpg, jpeg, png, heif, webp and max filesize is 40MB"
				label="Pick photo to scan for weekly schedule"
				@clear="clearImageUploadInput"
				@update:model-value="imageUploadChange"
			>
				<template v-slot:prepend>
					<q-icon name="attach_file" />
				</template>
			</q-file>
		</q-form>
		<q-img v-if="previewImageUrl" :src="previewImageUrl" class="q-mt-md" spinner-color="blue" />
		<div v-if="previewImageUrl" class="flex justify-end q-mt-lg">
			<q-btn class="q-mr-md" color="danger" flat label="Reset" @click="clearImageUploadInput" />
			<q-btn color="primary" icon="cloud_upload" label="Send" @click="submitImagePlan" />
		</div>
	</div>
</template>
